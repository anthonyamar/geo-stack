#!/bin/bash
set -e

# Remove a potentially pre-existing server.pid for Rails.
rm -f /rails/tmp/pids/server.pid

# Wait for PostgreSQL to be ready
until pg_isready -h $POSTGRES_HOST -p ${POSTGRES_PORT:-5432}; do
  echo "Waiting for PostgreSQL to be ready..."
  sleep 2
done

# Create extensions if they don't exist
echo "Creating PostgreSQL extensions if they don't exist..."
psql -h $POSTGRES_HOST -p ${POSTGRES_PORT:-5432} -U $POSTGRES_USER -d $POSTGRES_DB -c 'CREATE EXTENSION IF NOT EXISTS postgis;'
psql -h $POSTGRES_HOST -p ${POSTGRES_PORT:-5432} -U $POSTGRES_USER -d $POSTGRES_DB -c 'CREATE EXTENSION IF NOT EXISTS fuzzystrmatch;'
psql -h $POSTGRES_HOST -p ${POSTGRES_PORT:-5432} -U $POSTGRES_USER -d $POSTGRES_DB -c 'CREATE EXTENSION IF NOT EXISTS pg_trgm;'

# Prepare database (create, migrate, seed)
echo "Preparing database..."
bin/rails db:prepare

# Then exec the container's main process
exec "$@"
